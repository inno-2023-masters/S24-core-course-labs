# Cubernetes monitoring

## Stack explanation
- Grafana: A tool that turns metrics into customizable dashboards for in-depth
analysis and monitoring in Kubernetes.
- Prometheus Operator: Enhances the setup and ongoing management of Prometheus
setups in Kubernetes.
- Highly Available Prometheus: Ensures consistent metrics collection and
storage across a Kubernetes cluster for better reliability and uptime.
- Prometheus Node-Exporter: Collects important hardware and system metrics from
Kubernetes cluster nodes.
- Prometheus Blackbox-Exporter: Tests external services or endpoints for uptime
and responsiveness to ensure performance standards are met.
- Highly Available Alertmanager: Manages the production of alerts based on
conditions found by Prometheus, enhancing fault detection and alert capability.
- Prometheus Adapter for Kubernetes Metrics APIs: Gathers resource usage data
for Kubernetes, accessible via custom metrics APIs for informed scaling
decisions.
- Kube-State-Metrics: Provides detailed metrics on the status of Kubernetes
objects, helping understand cluster health and state.

## Preparation
To prepare for the lab, I run the following:

```sh
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
```

## Installation

```sh
user$ helm install monitoring prometheus-community/kube-prometheus-stack                                                                                                                                        lab14
NAME: monitoring
LAST DEPLOYED: Wed May 08 00:58:49 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
kube-prometheus-stack has been installed. Check its status by running:
  kubectl --namespace default get pods -l "release=monitoring"

Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create & configure Alertmanager and Prometheus instances using the Operator.
```


```
user $ kubectl get po,sts,svc,pvc,cm                                                                                                                                                                             lab14

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- Pod info -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

NAME                                                         READY   STATUS      RESTARTS   AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running     0          6m36s
pod/app-python-0                                             1/1     Running     2          9d
pod/app-python-1                                             1/1     Running     2          9d
pod/app-python-2                                             1/1     Running     2          9d
pod/app-python-test-connection                               0/1     Completed   0          32d
pod/monitoring-grafana-657659866f-hckh6                      3/3     Running     0          6m45s
pod/monitoring-kube-prometheus-operator-9bbbbb88b-6qdtm      1/1     Running     0          6m45s
pod/monitoring-kube-state-metrics-7fc7cf6558-hgd68           1/1     Running     0          6m45s
pod/monitoring-prometheus-node-exporter-l6f2v                1/1     Running     0          6m45s
pod/postinstall-hook                                         0/1     Completed   0          9d
pod/preinstall-hook                                          0/1     Completed   0          9d
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running     0          6m36s

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- StatefulSet info -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     6m36s
statefulset.apps/app-python                                             3/3     9d
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     6m36s

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- Service info -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   6m36s
service/app-python                                LoadBalancer   10.100.63.250    <pending>     8080:30365/TCP               9d
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP                      29d
service/monitoring-grafana                        ClusterIP      10.107.164.213   <none>        80/TCP                       6m45s
service/monitoring-kube-prometheus-alertmanager   ClusterIP      10.103.157.180   <none>        9093/TCP,8080/TCP            6m45s
service/monitoring-kube-prometheus-operator       ClusterIP      10.102.130.90    <none>        443/TCP                      6m45s
service/monitoring-kube-prometheus-prometheus     ClusterIP      10.103.104.84    <none>        9090/TCP,8080/TCP            6m45s
service/monitoring-kube-state-metrics             ClusterIP      10.105.240.180   <none>        8080/TCP                     6m45s
service/monitoring-prometheus-node-exporter       ClusterIP      10.99.39.204     <none>        9100/TCP                     6m45s
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP                     6m36s

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- Persistant volume info -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

NAME                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-vault-0          Bound    pvc-a451e441-3a17-4c4b-8201-54c92654fa56   10Gi       RWO            standard       20d
persistentvolumeclaim/visits-app-python-0   Bound    pvc-4ac2a1b1-6d56-4cc8-83ef-9f34e2a462c8   10Mi       RWO            standard       9d
persistentvolumeclaim/visits-app-python-1   Bound    pvc-2c0fb450-aca8-4482-8ebc-787b08c34b73   10Mi       RWO            standard       9d
persistentvolumeclaim/visits-app-python-2   Bound    pvc-42130b50-c037-4975-8414-07c8b4218190   10Mi       RWO            standard       9d

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- ConfigMap info -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

NAME                                                                     DATA   AGE
configmap/config                                                         1      9d
configmap/kube-root-ca.crt                                               1      38d
configmap/monitoring-grafana                                             1      6m45s
configmap/monitoring-grafana-config-dashboards                           1      6m45s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      6m45s
configmap/monitoring-kube-prometheus-apiserver                           1      6m45s
configmap/monitoring-kube-prometheus-cluster-total                       1      6m45s
configmap/monitoring-kube-prometheus-controller-manager                  1      6m45s
configmap/monitoring-kube-prometheus-etcd                                1      6m45s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      6m45s
configmap/monitoring-kube-prometheus-grafana-overview                    1      6m45s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      6m45s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      6m45s
configmap/monitoring-kube-prometheus-kubelet                             1      6m45s
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      6m45s
configmap/monitoring-kube-prometheus-namespace-by-workload               1      6m45s
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      6m45s
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      6m45s
configmap/monitoring-kube-prometheus-nodes                               1      6m45s
configmap/monitoring-kube-prometheus-nodes-darwin                        1      6m45s
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      6m45s
configmap/monitoring-kube-prometheus-pod-total                           1      6m45s
configmap/monitoring-kube-prometheus-prometheus                          1      6m45s
configmap/monitoring-kube-prometheus-proxy                               1      6m45s
configmap/monitoring-kube-prometheus-scheduler                           1      6m45s
configmap/monitoring-kube-prometheus-workload-total                      1      6m45s
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   35     6m36s
```

## CPU & Memory usage for stateful set
[](./screenshots/cpu_memory_sts.png)

## CPU usage of pods
[](./screenshots/pods_cpu_usage.png)

## Node memory usage
[](./screenshots/node_memory_usage.png)

## Kubelet managed containers
[](./screenshots/kubelet_managed_containers.png)

## Network usage of pods
[](./screenshots/pods_network_usage.png)

## Number of active alerts
[](./screenshots/active_alerts.png)

# Init containers
[](./screenshots/init_container.png)
